global.BOOT=function(params){"use strict";var fs=require("fs"),path=require("path"),OTHER_LANGS=params.OTHER_LANGS,rootPath=__dirname+"/..",browserScript="\nglobal = window;\n",securedBrowserScript="\nglobal = window;\n",css="",securedCSS="",logoText,pageContent="",stringifyJSONWithFunction,loadAll,generatePageContent,startServer;stringifyJSONWithFunction=function(data){return JSON.stringify(data,function(e,t){return"function"==typeof t?"__THIS_IS_FUNCTION_START__"+t.toString()+"__THIS_IS_FUNCTION_END__":t},"	").replace(/("__THIS_IS_FUNCTION_START__(.*)__THIS_IS_FUNCTION_END__")/g,function(match,content){return eval("("+eval('"'+content.substring('"__THIS_IS_FUNCTION_START__'.length,content.length-'__THIS_IS_FUNCTION_END__"'.length)+'"')+")").toString()})},loadAll=function(){var e,t,n,o,r,i,a,s,c,d,u,l,S,p,C;e=function(e){var t=e.path,n=e.name;return fs.statSync(rootPath+"/"+t).isDirectory()===!0&&"."!==n[0]&&"node_modules"!==n&&"not_load"!==n&&"deprecated"!==n&&"_"!==n[0]},t=function(){fs.readdirSync(rootPath).forEach(function(t){e({path:t,name:t})===!0&&(global[t]=BOX(t),browserScript+="global."+t+" = BOX('"+t+"');\n",securedBrowserScript+="global."+t+" = BOX('"+t+"');\n")})},n=function(e){var t,n=rootPath+"/"+e,o=path.extname(e);".js"===o&&require(n);for(t in OTHER_LANGS)OTHER_LANGS.hasOwnProperty(t)===!0&&o==="."+t&&require(n)},o=function(e){var t,n=rootPath+"/"+e,o=path.extname(e),r=fs.readFileSync(n).toString();".js"===o?(browserScript+=r+"\n",securedBrowserScript+=r+"\n"):".css"===o&&(css+=r,securedCSS+=r);for(t in OTHER_LANGS)OTHER_LANGS.hasOwnProperty(t)===!0&&o==="."+t&&(browserScript+=OTHER_LANGS[t](r)+"\n",securedBrowserScript+=OTHER_LANGS[t](r)+"\n")},r=function(e){var t,n=rootPath+"/"+e,o=path.extname(e),r=fs.readFileSync(n).toString();".js"===o?securedBrowserScript+=r+"\n":".css"===o&&(securedCSS+=r+"\n");for(t in OTHER_LANGS)OTHER_LANGS.hasOwnProperty(t)===!0&&o==="."+t&&(securedBrowserScript+=OTHER_LANGS[t](r)+"\n")},i=function(e){n(e),o(e)},a=function(t,n){var o=function(t){var r,i;if(fs.existsSync(t)===!0)for(r=[],fs.readdirSync(t).forEach(function(o){var i=t+"/"+o;e({path:i,name:o})===!0?r.push(i):fs.statSync(rootPath+"/"+i).isDirectory()!==!0&&n(i)}),i=0;i<r.length;i+=1)o(r[i])};FOR_BOX(function(e){o(e.boxName+"/"+t)})},s=function(e){a(e,n)},c=function(e){a(e,o)},d=function(e){a(e,r)},u=function(e){a(e,i)},l=function(){void 0!==params&&(void 0!==params.CONFIG&&(EXTEND_DATA({origin:global.CONFIG,extend:params.CONFIG}),browserScript+="EXTEND_DATA({ origin : global.CONFIG, extend : "+stringifyJSONWithFunction(params.CONFIG)+" });\n",securedBrowserScript+="EXTEND_DATA({ origin : global.CONFIG, extend : "+stringifyJSONWithFunction(params.CONFIG)+" });\n"),void 0!==params.SERVER_CONFIG&&(EXTEND_DATA({origin:global.SERVER_CONFIG,extend:params.SERVER_CONFIG}),SERVER_CONFIG.rootPath=rootPath),void 0!==params.BROWSER_CONFIG&&(browserScript+="EXTEND_DATA({ origin : global.BROWSER_CONFIG, extend : "+stringifyJSONWithFunction(params.BROWSER_CONFIG)+" });\n",securedBrowserScript+="EXTEND_DATA({ origin : global.BROWSER_CONFIG, extend : "+stringifyJSONWithFunction(params.BROWSER_CONFIG)+" });\n")),CONFIG.version=String((new Date).getTime()),browserScript+="CONFIG.version = "+CONFIG.version+";\n",securedBrowserScript+="CONFIG.version = "+CONFIG.version+";\n"},S=function(){var e=UPPERCASE.MODULE("mongolian");UPPERCASE.db=(new e).db(SERVER_CONFIG.dbName),SERVER_CONFIG.isNotRequireDBAuth!==!0&&UPPERCASE.db.auth(SERVER_CONFIG.dbUsername,SERVER_CONFIG.dbPassword)},p=function(){var e=UPPERCASE.MODULE("uglify-js"),t=UPPERCASE.MODULE("sqwish");browserScript=e.minify(browserScript,{fromString:!0,mangle:!0}).code,securedBrowserScript=e.minify(securedBrowserScript,{fromString:!0,mangle:!0}).code,css=t.minify(css),securedCSS=t.minify(securedCSS)},C=function(){logoText=fs.readFileSync(rootPath+"/UPPERCASE/LOGO"),browserScript="/* Welcome to JavaScript World! :)\n"+logoText+"\n  Contact: "+CONFIG.contactAddress+"\n\n*/"+browserScript,css="/* Welcome to CSS World! :)\n"+logoText+"\n  Contact: "+CONFIG.contactAddress+"\n\n*/"+css},i("UPPERCASE/METHOD.js"),i("UPPERCASE/CLASS.js"),i("UPPERCASE/OBJECT.js"),i("UPPERCASE/BOX.js"),t(),i("UPPERCASE/FOR_BOX.js"),u("COMMON"),s("SERVER"),c("BROWSER"),d("BROWSER_SECURED"),o("UPPERCASE/BROWSER_FIX.js"),l(),SERVER_CONFIG.isNotUseDB!==!0&&S(),o("UPPERCASE/BROWSER_INIT.js"),CONFIG.isDevMode!==!0&&p(),C()},generatePageContent=function(){pageContent+="<!DOCTYPE html>",pageContent+="<!--\n\n  Welcome! :)\n"+logoText+"\n  Contact: "+CONFIG.contactAddress+"\n\n-->",pageContent+="<html>",pageContent+="<head>",pageContent+='<meta charset="utf-8">',pageContent+='<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">',pageContent+='<meta name="google" value="notranslate">',void 0!==CONFIG.googleSiteVerificationKey&&(pageContent+='<meta name="google-site-verification" content="'+CONFIG.googleSiteVerificationKey+'" />'),pageContent+="<title>"+CONFIG.defaultTitle+"</title>",pageContent+='<link rel="stylesheet" type="text/css" href="__CSS?'+CONFIG.version+'" />',pageContent+="</head>",pageContent+="<body>",pageContent+="<noscript>",pageContent+='<p style="padding:15px;">',pageContent+="자바스크립트 기능이 꺼져있습니다. 브라우저의 자바스크립트 기능을 켜 주시기 바랍니다. 감사합니다~! ^-^",pageContent+="<br>",pageContent+="JavaScript is disabled. Please enable JavaScript in your browser. Thank you~! :)",pageContent+="</p>",pageContent+="</noscript>",pageContent+='<script type="text/javascript" src="__SCRIPT?'+CONFIG.version+'"></script>',pageContent+="</body>",pageContent+="</html>"},startServer=function(){var e,t,n,o,r=require("http"),i=require("https"),a=UPPERCASE.MODULE("socket.io"),s=UPPERCASE.MODULE("formidable").IncomingForm,c=UPPERCASE.MODULE("imagemagick");o=function(e,t){var n,o,r,i,a,d,u,l,S,p,C,f,O,E,g,N,_,R,v,F,h,m,I,P,G,T=e.url,y={};a=function(e){var t=path.extname(e);return".png"===t?"image/png":".jpg"===t||".jpeg"===t?"image/jpeg":".gif"===t?"image/gif":".js"===t?"text/javascript":".css"===t?"text/css":".txt"===t?"text/plain":".html"===t?"text/html":".swf"===t?"application/x-shockwave-flash":"application/octet-stream"},d=function(e){return"text/javascript"===e?"utf-8":"text/css"===e?"utf-8":"text/plain"===e?"binary":"text/html"===e?"utf-8":"image/png"===e?"binary":"image/jpeg"===e?"binary":"image/gif"===e?"binary":"application/x-shockwave-flash"===e?"binary":"binary"},u=function(){var e=T.indexOf("?");-1!==e&&(o=T.substring(e+1),T=T.substring(0,e))},l=function(){n=T.substring(1)},S=function(){var e=n.indexOf("/");-1===e?r=CONFIG.defaultBoxName:(r=n.substring(0,e),n=n.substring(e+1))},p=function(){var e=n.indexOf("/");-1===e?i="":(i=n.substring(0,e),n=n.substring(e+1))},C=function(){var t;return void 0===e.headers.authorization?!1:(t=new Buffer(e.headers.authorization.split(" ")[1],"base64").toString().split(":"),console.log("Decoded authorization: "+t),t[0]===SERVER_CONFIG.securedUsername&&t[1]===SERVER_CONFIG.securedPassword)},f=function(t){return void 0===t?void 0!==e.headers["if-none-match"]:e.headers["if-none-match"]===t},O=function(e){t.writeHead(302,{Location:e}),t.end()},E=function(){console.log("Someone is trying to AUTH!: "+e.connection.remoteAddress),t.statusCode=401,t.setHeader("WWW-Authenticate",'Basic realm="AUTH"'),t.end()},g=function(){t.statusCode=304,t.end()},N=function(e){var n=e.key,o=e.content,r=e.contentType,i=e.encoding;t.setHeader("Content-Type",r),void 0!==n&&t.setHeader("ETag",n),t.statusCode=200,t.end(o,i)},_=function(){O("/"+CONFIG.defaultBoxName+"/R/favicon.ico")},R=function(){return void 0===e.headers.authorization?void E():C()===!0?void O(SERVER_CONFIG.authedPageUrl):void O("/UPPERCASE/R/AUTH_ERROR.html")},v=function(){N({content:pageContent,contentType:"text/html",encoding:"utf-8"})},F=function(){f(CONFIG.version)===!0&&CONFIG.isDevMode!==!0?g():o!==CONFIG.version&&CONFIG.isDevMode!==!0?O(T+"?"+CONFIG.version):N(C()===!0?{key:CONFIG.version,content:securedBrowserScript,contentType:"text/javascript",encoding:"utf-8"}:{key:CONFIG.version,content:browserScript,contentType:"text/javascript",encoding:"utf-8"})},h=function(){f(CONFIG.version)===!0&&CONFIG.isDevMode!==!0?g():o!==CONFIG.version&&CONFIG.isDevMode!==!0?O(T+"?"+CONFIG.version):N(C()===!0?{key:CONFIG.version,content:securedCSS,contentType:"text/css",encoding:"utf-8"}:{key:CONFIG.version,content:css,contentType:"text/css",encoding:"utf-8"})},m=function(){var n=new s,o=[],i={};n.uploadDir="__RF/"+r+"/__TEMP/",fs.existsSync(rootPath+"/"+n.uploadDir)===!1&&console.log("Not exists folder: "+rootPath+"/"+n.uploadDir),void 0!==global[r]&&fs.existsSync(rootPath+"/"+n.uploadDir)===!0?(n.on("field",function(e,t){i[e]=t}).on("file",function(e,t){o.push({tempPath:t.path,size:t.size,name:t.name,type:t.type,lastModifiedDate:t.lastModifiedDate})}).on("end",function(){var e=global[r].DB("__UPLOAD_FILE"),n=0;EACH(o,function(a){var s=a.tempPath;return a.size>1024*CONFIG.maxUploadFileMB*1024?(t.writeHead(200,{"Content-Type":"text/html"}),t.end("<script>errorCode='SIZE'</script>","utf-8"),!1):(EACH(i,function(e,t){""!==e.trim()&&(a[t]=e)}),REMOVE_AT({data:a,key:"tempPath"}),void c.readMetadata(s,function(i,d){var u=function(){e.createData(a,function(e,i){var a=UPPERCASE.MODULE("mv"),c=rootPath+"/__RF/"+r+"/"+i.id;void 0===e&&a(s,c,function(){n+=1,n===o.length&&(EACH(o,function(e,t){o[t]=PACK_DATA(e)}),t.writeHead(200,{"Content-Type":"text/html"}),t.end("<script>fileDataSet="+JSON.stringify(o)+"</script>","utf-8")),console.log("File '"+c+"' ("+i.name+", "+i.size+" byte) uploaded.")})})};void 0!==d.exif?(a.exif=d.exif,c.convert([s,"-auto-orient",s],function(){u()})):u()}))})}).on("error",function(){t.writeHead(200,{"Content-Type":"text/html"}),t.end("<script>errorCode='ERROR'</script>","utf-8")}),n.parse(e)):(t.writeHead(200,{"Content-Type":"text/html"}),t.end("<script>errorCode='ERROR'</script>","utf-8"))},I=function(){var e,t,i;f(CONFIG.version)===!0?g():o!==CONFIG.version?O(T+"?"+CONFIG.version):(e=rootPath+"/"+r+"/R/"+n,void 0!==y[e]?N(y[e]):(t=a(n),i=d(t),fs.exists(e,function(n){n===!0?fs.readFile(e,i,function(n,o){null!==n?G():N(y[e]={key:CONFIG.version,content:o,contentType:t,encoding:i})}):G()})))},P=function(){var e;f()===!0?g():(e=rootPath+"/__RF/"+r+"/"+n,fs.exists(e,function(t){t===!0?fs.readFile(e,"binary",function(t,n){null!==t?G():fs.stat(e,function(e,t){null!==e?G():N({key:t.size+"-"+Date.parse(t.mtime),content:n,contentType:"application/octet-stream",encoding:"binary"})})}):G()}))},G=function(){O(SERVER_CONFIG.errorPageUrl)},u(),l(),"favicon.ico"===n?_():"__AUTH"===n?R():""===n?v():"__SCRIPT"===n?F():"__CSS"===n?h():(S(),p(),"R"===i?I(r):"RF"===i?P(r):"__UPLOAD"===n&&"POST"===e.method.toUpperCase()?m():G())},e=r.createServer(o).listen(CONFIG.port),void 0!==SERVER_CONFIG.securedPort&&(t=i.createServer({key:fs.readFileSync(rootPath+"/"+SERVER_CONFIG.securedKeyFileName),cert:fs.readFileSync(rootPath+"/"+SERVER_CONFIG.securedCrtFileName)},o).listen(SERVER_CONFIG.securedPort)),n=a.listen(e),CONFIG.isDevMode===!0?n.set("log level",2):n.set("log level",1),n.set("transports",["websocket","flashsocket","xhr-polling","jsonp-polling"]),CONNS.type.socketPack=n.sockets,OBJECT.init(),FOR_BOX(function(e){void 0!==e.MAIN&&e.MAIN()}),console.log("[UPPERCASE SERVER STARTED] http://localhost:"+CONFIG.port+(void 0!==SERVER_CONFIG.securedPort?" and secured server started. https://localhost:"+SERVER_CONFIG.securedPort:""))},loadAll(),generatePageContent(),startServer()};